---
title: "SIR 2023-2026 Specifications Economics"
author: "Min-Yang Lee"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    df_print: paged
  word_document: default
  pdf_document:
    keep_tex: yes
    fig_caption: yes
    number_sections: yes
header-includes: \usepackage{setspace}\doublespacing
urlcolor: blue
editor_options:
  chunk_output_type: console
fontsize: 12pt
---
<!-- 
bibliography: Canyons.bib

This is the markdown document used to do the RFA section for the SIR 2023-2026 herring Specifications. Only a RFA section is necessary; 12866 is not necessary because there are no implementing regulations.  

This was copied over from the Canyons and Seamounts Economic Analysis. I think alot if it is unecessary and I need to cut it down.
-->
 
 
 <!---- 
 The global_options chunk loads libraries, sets options, figures out if you're on a desktop or server, sets years, and sets graphing options
 --->
```{r global_options, include=FALSE}

 library("foreign")
# library("data.table")
# library("lattice")
 library("scales")
 library("ggplot2")
 library("dplyr")
 library("tidyr")
 library("stringr")
 library("knitr")
 library("lubridate")
# library("devtools")
 library("RODBC")
# library("classInt")
library("here")
 library("kableExtra")
# library("tinytex")
# library("viridis")

here::i_am("SIR2023_2026/writing/SIR2023_Economic_Impacts.Rmd")

#############################################################################
#knitr options

knitr::opts_chunk$set(echo=FALSE, warning = FALSE, error = FALSE, message = FALSE, comment = FALSE, cache = FALSE, progress = TRUE, verbose = FALSE, 
											dpi = 600)
options(tinytex.verbose = TRUE)
# options(knitr.table.format = "latex")

# knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, encoding = encoding, output_file = file.path(dirname(inputFile), 'myfile.pdf')) })
#############################################################################


#############################################################################
# figure out the OS 
# Different setups based on whether you are using Windows or Not-windows
desktopUse = ifelse(unname(Sys.info()["sysname"]) == "Windows", TRUE, FALSE)


# We have set network_location_desktop and network_location_remote in  .Rprofile
  if (desktopUse) { # set the root path of the network, based on whether on desktop or server
    network_location = network_location_desktop
    system("ipconfig", intern = TRUE)
  } else {
    network_location = network_location_remote
  }




# RFA data
RFA_filepath<-file.path(network_location,"work5", "socialsci", "RFA_EO12866 Guidelines","ownership_data","current data and metadata","affiliates_2022_06_01.Rdata")


#############################################################################


deflate_by <- "year"
#base year and/or quarter for GDP Deflator
base_year = 2020 # base year for GDP deflator - Maximum = 2020, Minimum = 1947  - max(GDPDEF_quarterly$Year)
base_quarter = "" # base quarter for GDP deflator e.g. "Q1", "Q2" etc. Maximum = Q1 of 2020, Minimum = Q1 of 1947 - leave blank to query by year


  
###################################################################################################
```

```{r Set_switches, eval=TRUE}


# Data_Process_Switch<-TRUE will extract and process data. This takes a while, so set to FALSE after you run the first time.
Data_Process_Switch<-FALSE

source(here("R_code","project_logistics","R_credentials_RODBC.R"))

```	




 <!---- 
 The data_process_Canyons knits a child RMD.  There are a bunch of 'options' that were originally set in these chunks. I've moved most of them to the global_options and set_switches sections. but not all of them. And some are hard coded. 
 
 This only works when you knit, not when you run a chunk.
 --->

```{r child=here("writing","SIR2023-2026", "data_process_SIR2023.Rmd"), eval=Data_Process_Switch}
```

<!---
\setcounter{section}{4}
\setcounter{subsection}{1}
\setcounter{figure}{3}
\setcounter{table}{32}
--->

## Regulatory Flexibility Act Analysis

###  A description of the reasons why action by the agency is being considered.
By reference

### A succinct statement of the objectives of, and legal basis for, the proposed rule.
By reference

### Number of Small entities

The directly regulated entities are the firms that currently hold at least 1 Northeast US herring fishing permit.  SSS of the small firms derive the majority of their revenue from commercial fishing operations.   derive the majority of their revenue from for-hire recreational activities.  Firms that are classified as "for-hire" may still fish commercially -- these firms are included in the tabulation of directly regulated entities, although their main source of income (for-hire fishing) would not be directly impacted  by the proposed action. 

```{r Directly_Regulated_Entities, eval=TRUE}
load(RFA_filepath)
affiliates<-affiliates_2022_06_01
finalyr<-max(affiliates$year)

rm(affiliates_2022_06_01)
affiliates$permit_count<-1
# Recode small_business to a print friendly string (Large, Small). Recode entity_type to nice casing

affiliates<-affiliates %>%
  mutate(entity_type_2021=replace(entity_type_2021, entity_type_2021=="FISHING","Fishing"),
         entity_type_2021=replace(entity_type_2021, entity_type_2021=="FORHIRE","For-Hire"),
         SB_string=case_when(
           small_business==1 ~ "Small",
           small_business==0 ~ "Large")
         ) %>%
    relocate(SB_string, .after=small_business) 

# Make a keyfile that has picks off the last year of data.Get the entity type, small business dummy, the number of herring permits, number of LA herring_permits, and the number of vessels as well. The filter(herring>=1) actually cuts out alot of rows
herring2021<-affiliates %>%
  group_by(affiliate_id) %>%
  summarise(Type=first(entity_type_2021), Size=first(SB_string),
            vessels=sum(permit_count),
            herringrev=sum(value168),
            herring=sum(c_across(starts_with("HRG_"))),
            herringLA=sum(HRG_A+ HRG_B+HRG_C)
            ) %>%
  filter(herring>=1)

# Compute yearly average revenues, including average revenues by species. Rename the value_permit to value_firm to reflect the change in the column when we do the final summarise
  summary_affiliates<-affiliates %>%
  group_by(affiliate_id,year) %>%
  summarise(across(value_permit:value834, sum)) %>%  # Creates a firm-year dataset of values 
    ungroup() %>%
  group_by(affiliate_id) %>%
  summarise(across(value_permit:value834, mean)) %>% # Takes the mean of the firm-level dataset of values
    rename(value_firm=value_permit, value_firm_forhire=value_permit_forhire)
            

#merge together they keyfile and the average revenue, keeping just the affiliate_ids that show up in herring2021
Directly_Regulated_Entities<-left_join(herring2021,summary_affiliates,by='affiliate_id')



# Summary of DRE large and small firms in the fishing and for-hire industries. Exclude the inactive (NO_REV).
Directly_Regulated_Entities_table <- Directly_Regulated_Entities %>%
  filter(Type !="NO_REV") %>%
  group_by(Size, Type) %>%
  summarise(Firms=n(),
            Vessels=sum(vessels),
            "Avg Gross Receipts"=round(mean(value_firm),0),
            "Avg Herring Receipts"=round(mean(value168),0),
            "25th pct Gross Receipts" = round(quantile(value_firm, probs=.25),0),
            "75th pct Gross Receipts"=round(quantile(value_firm, probs=.75),0)
           ) %>%
  mutate(across(c(`Firms`,`Vessels`), ~ number(.x, big.mark=","))) %>%
  mutate(across(c(`Avg Gross Receipts`,`Avg Herring Receipts`, `25th pct Gross Receipts`, `75th pct Gross Receipts` ), ~ number(.x, accuracy=1000,prefix="$", big.mark=",")))

 
kbl(Directly_Regulated_Entities_table, digits=0,booktabs=T, align=c("l",rep('r',times=7)), caption =  "Number and Characterization of the  Directly Regulated Entities, Trailing Three Years of Data") %>%
    #column_spec(5:8, width = "2cm")
    kable_styling(full_width = T) %>% 
      row_spec(0,bold=TRUE) 
```

Table \ref{tab:Directly_Regulated_Entities} describes numbers of directly regulated entities, their main activities, and their revenues from various sources. 

```{r LA_DREs}
# Make a keyfile based on herring2021 that just has firms with at least 1 LA herring permit. 

LAherring2021<-herring2021 %>%
  filter(herringLA>=1)
LA_DREs<-left_join(LAherring2021,summary_affiliates,by='affiliate_id')


# Summary of DRE large and small firms in the fishing and for-hire industries.
# Should recode small_business to a print friendly string (Large, Small)
LAherring2021_table <- LA_DREs %>%
  filter(Type !="NO_REV") %>%
  group_by(Size, Type) %>%
  summarise(Firms=n(),
            Vessels=sum(vessels),
            "Avg Gross Receipts"=round(mean(value_firm),0),
            "Avg Herring Receipts"=round(mean(value168),0),
            "25th pct Gross Receipts" = round(quantile(value_firm, probs=.25),0),
            "75th pct Gross Receipts"=round(quantile(value_firm, probs=.75),0)
           ) %>%
  mutate(across(c(`Firms`,`Vessels`), ~ number(.x, big.mark=","))) %>%
  mutate(across(c(`Avg Gross Receipts`,`Avg Herring Receipts`, `25th pct Gross Receipts`, `75th pct Gross Receipts` ), ~ number(.x, accuracy=1000,prefix="$", big.mark=",")))



kbl(LAherring2021_table, digits=0,booktabs=T, align=c("l",rep('r',times=7)), caption =  "Number and Characterization of the  Directly Regulated Entities, Trailing Three Years of Data") %>%
    #column_spec(5:8, width = "2cm")
    kable_styling(full_width = T) %>% 
      row_spec(0,bold=TRUE) 

```



```{r Active_DREs}
# Make a keyfile based on herring2021 that just has firms that landed any herring 

Active_DRE<-herring2021 %>%
  filter(herringrev>=1)
Active_DRE<-left_join(Active_DRE,summary_affiliates,by='affiliate_id')

# Summary of firms active in herring large and small firms in the fishing and for-hire industries.
# Should recode small_business to a print friendly string (Large, Small)
Active_DRE_table <- Active_DRE %>%
  filter(Type !="NO_REV") %>%
  group_by(Size, Type) %>%
  summarise(Firms=n(),
            Vessels=sum(vessels),
            "Avg Gross Receipts"=round(mean(value_firm),0),
            "Avg Herring Receipts"=round(mean(value168),0),
            "25th pct Gross Receipts" = round(quantile(value_firm, probs=.25),0),
            "75th pct Gross Receipts"=round(quantile(value_firm, probs=.75),0)
           ) %>%
  mutate(across(c(`Firms`,`Vessels`), ~ number(.x, big.mark=","))) %>%
  mutate(across(c(`Avg Gross Receipts`,`Avg Herring Receipts`, `25th pct Gross Receipts`, `75th pct Gross Receipts` ), ~ number(.x, accuracy=1000,prefix="$", big.mark=",")))



kbl(Active_DRE_table, digits=0,booktabs=T, align=c("l",rep('r',times=7)), caption =  "Number and Characterization of the  Directly Regulated Entities, Trailing Three Years of Data") %>%
    #column_spec(5:8, width = "2cm")
    kable_styling(full_width = T) %>% 
      row_spec(0,bold=TRUE) 

```


Table \ref{tab:LA_DREs} describes numbers of directly regulated entities that hold at least 1 Limited Access Herring permit (categories A, B, or C), their main activities, and their revenues from various sources. 

### Impacts on Small firms



### Compliance Requirements
A description of the projected reporting, record-keeping, and other compliance requirements of the proposed rule, including an estimate of the classes of small entities which will be subject to the requirements of the report or record.

### Duplications
An identification, to the extent practicable, of all relevant Federal rules, which may duplicate, overlap, or conflict with the proposed rule.


\newpage

